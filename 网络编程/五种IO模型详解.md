[TOC]
## **五种I/O模式**详解

- 阻塞I/O
- 非阻塞I/O 
- I/O多路复用 
- 信号驱动I/O
- 异步I/O

### 阻塞I/O模式

进程会一直阻塞，直到数据拷贝完成

**理解案例**

调用recv()函数，系统首先检测是否准备好数据，没有准备好就一直等待，此时就是阻塞

在调用socket函数创建套接字时，默认的套接字都是阻塞的，意味着调用此API未完成时，该线程会一直挂起等待，直到调用完成

**模式优点**

使用此模式开发较为简单，容易实现

**模式缺点**

效率低，如果有I/O等待数据，我们就会一直挂起等待，代码无法往下执行

![img](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/20190313205158429.png)

### 非阻塞I/O模式

**案例**

当我们将一个套接字设置为非阻塞模式，我们相当于告诉了系统内核：当我请求的I/O操作不能够马上完成时，请马上返回一个错误给我。我们开始对recvfrom的三次调用，因为系统还没有接收到网络数据，所以内核马上返回一个EWOULDBLOCK的错误，直到数据包到达，然后recvfrom正常返回，我们就可以读接收的数据进行处理了。

 当一个应用程序使用了非阻塞模式的套接字，**它需要一个循环不断的测试一个文件描述符有数据可读（称做polling）应用程序不停的polling内核来检查是否I/O操作已经就绪。这将是一个极其浪费CPU资源的操作。**这种模式使用中不太常见。

![img](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/20190313212933561.png)

**缺点**

非阻塞模式的使用并不普通，因为非阻塞模式会浪费大量的资源

### **I/O多路复用**

在使用I/O多路技术的时候，我们调用select()、poll()、epoll()（2.6内核开始支持），在调用它们的时候阻塞**（监视文件描述符的变化）**，而不是我们调用recvfrom（或recv）的时候阻塞。

**与单个I/O操作的比较**

单个I/O操作也要等待数据（recv），多路复用技术也要等待，而且还要先调用select等函数，看起来好像没有什么意义，但是它能同时监视多个文件描述符，一旦一个进入了就绪状态，select函数就可以返回（因为是进入了就绪状态才返回的，所以调用recvfrom函数不会等待数据，数据已经有了）

![img](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/20190315190101303.png)

**I/O多路技术的使用情况**

- 当一个客户端需要同时处理多个文件描述符的输入输出操作的时候（一般来说是标准的输入输出和网络套接字)，I/O 多路复用技术将会有机会得到使用。
- 当程序需要同时进行多个套接字的操作的时候。
- 如果一个 TCP 服务器程序同时处理正在侦听网络连接的套接字和已经连接好的套接字。
- 如果一个服务器程序同时使用 TCP 和 UDP 协议。
- 如果一个服务器同时使用多种服务并且每种服务可能使用不同的协议（比如 inetd就是这样的）。

### **信号驱动I/O模式**

我们可以使用信号，让内核在文件描述符就绪的时候使用SIGIO信号来通知我们。我们将这种模式称为信号驱动I/O模式

**优点**

代码继续往下执行，等到内核发信号告诉我们再去处理

为了在一个套接字上使用信号驱动 I/O 操作，下面这三步是所必须的。

- 一个和 SIGIO信号的处理函数必须设定。
- 套接字的拥有者必须被设定。一般来说是使用 fcntl 函数的 F_SETOWN 参数来进行设定拥有者。
- 套接字必须被允许使用`异步 I/O`。一般是通过调用 fcntl 函数的 F_SETFL 命令，O_ASYNC为参数来实现。

![img](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/20190315194201132.png)

### **异步I/O模式**

当我们运行在异步 I/O 模式下时，我们如果想进行 I/O 操作，只需要告诉内核我们要进行 I/O 操作，然后内核会马上返回。具体的 I/O 和数据的拷贝全部由内核来完成，我们的程序可以继续向下执行。当内核完成所有的 I/O 操作和数据拷贝后，内核将通知我们的程序。

**异步 I/O 和  信号驱动I/O的区别**

- 信号驱动 I/O 模式下，内核在操作可以被操作的时候通知给我们的应用程序发送SIGIO 消息。
- 异步 I/O 模式下，内核在所有的操作都已经被内核操作结束之后才会通知我们的应用程序。

![image-20211015222942231](https://syz-picture.oss-cn-shenzhen.aliyuncs.com/image-20211015222942231.png)

## 钓鱼的例子

参考CSDN老哥的例子

**阻塞I/O**

A钓鱼，他就一直等鱼上钩，再做别的事情

**非阻塞I/O模式**

A钓鱼，但是他还看报纸，刷手机并时不时的`轮询`查看上钩没

**I/O多路复用**

A钓鱼，他拿了好多个鱼竿钓鱼，然后监视这些鱼竿哪个钓到了鱼，提升了效率

**信号驱动I/O模式**

A钓鱼，但是他很聪明，他把铃铛挂到鱼钩上，然后干别的事情，铃铛响了他再去拉鱼

**异步I/O模式**

A钓鱼，但是他雇了B来帮他钓鱼，等B成功了，B打电话给A

## 参考

- [(128条消息) 五种IO模型（详解+形象例子说明）_ZWE7616175的博客-CSDN博客](https://blog.csdn.net/ZWE7616175/article/details/80591587)[(128条消息) 五种I/O模式 — 阻塞I/O 非阻塞I/O I/O多路复用 信号驱动I/O 异步I/O_QX_a11的博客-CSDN博客](https://blog.csdn.net/QX_a11/article/details/88540557?ops_request_misc=%7B%22request%5Fid%22%3A%22163429320216780261959769%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=163429320216780261959769&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-88540557.pc_search_result_hbase_insert&utm_term=阻塞I%2FO&spm=1018.2226.3001.4187)
- [(128条消息) 五种I/O模式 — 阻塞I/O 非阻塞I/O I/O多路复用 信号驱动I/O 异步I/O_QX_a11的博客-CSDN博客](https://blog.csdn.net/QX_a11/article/details/88540557?ops_request_misc=%7B%22request%5Fid%22%3A%22163429320216780261959769%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=163429320216780261959769&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-88540557.pc_search_result_hbase_insert&utm_term=阻塞I%2FO&spm=1018.2226.3001.4187)
- 《Linux高性能服务器编程》

